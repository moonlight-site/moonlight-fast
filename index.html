<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>moonlight - games</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter+Tight:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
    :root {
        --bg: #050505;
        --glass: rgba(255, 255, 255, 0.03);
        --glass-border: rgba(255, 255, 255, 0.1);
        --text-main: #ffffff;
        --text-muted: #888888;
        --font: 'Inter Tight', sans-serif;
    }

    * { box-sizing: border-box; outline: none; }
    body { margin: 0; background: var(--bg); color: var(--text-main); font-family: var(--font); overflow-x: hidden; min-height: 100vh; }

    .wrap { max-width: 1400px; margin: 0 auto; padding: 30px; }

    /* Header */
    .header {
        display: flex; flex-direction: column; gap: 20px; padding: 20px; margin-bottom: 40px;
        background: var(--glass); border: 1px solid var(--glass-border); border-radius: 20px;
        backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
        box-shadow: 0 0 40px rgba(255, 255, 255, 0.08);
    }
    @media(min-width: 768px) { .header { flex-direction: row; align-items: center; justify-content: space-between; } }

    .brand { display: flex; align-items: center; gap: 15px; }
    .brand-text h1 { margin: 0; font-size: 24px; font-weight: 600; }
    .brand-text p { margin: 0; font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 500; }

    .brand-stats { display: flex; align-items: center; gap: 10px; font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 500; margin-top: 8px; }
    .online-indicator { width: 8px; height: 8px; background: #22c55e; border-radius: 50%; animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .online-count { color: #22c55e; font-weight: 600; }

    .controls { display: flex; gap: 10px; flex-wrap: wrap; }

    input, select, button {
        background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border);
        color: white; padding: 12px 20px; border-radius: 12px; font-family: var(--font);
    }
    button { cursor: pointer; transition: 0.3s; }
    button:hover { background: white; color: black; }

    #settingsBtn, #refreshBtn {
        transition: 0.3s all;
    }

    #settingsBtn:hover, #refreshBtn:hover {
        box-shadow: 0 0 30px rgba(255, 255, 255, 0.3), inset 0 0 20px rgba(255, 255, 255, 0.1);
    }

    /* Mission Popup Styles */
    .popup-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); backdrop-filter: blur(8px);
        z-index: 10000; display: flex; align-items: center; justify-content: center;
        opacity: 0; visibility: hidden; transition: 0.4s;
    }
    .popup-overlay.show { opacity: 1; visibility: visible; }
    
    .popup-content {
        background: #0a0a0a; border: 1px solid var(--glass-border);
        padding: 40px; border-radius: 24px; max-width: 500px; width: 90%;
        text-align: center; transform: scale(0.9); transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        box-shadow: 0 0 60px rgba(255, 255, 255, 0.2);
    }
    .popup-overlay.show .popup-content { transform: scale(1); }
    
    .popup-content h2 { margin-top: 0; font-size: 28px; font-weight: 700; }
    .popup-content p { color: var(--text-muted); line-height: 1.6; font-size: 16px; margin-bottom: 30px; }
    .continue-btn { width: 100%; padding: 15px; font-weight: 700; font-size: 16px; }

    /* Settings Popup Styles */
    .settings-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); backdrop-filter: blur(8px);
        z-index: 9999; display: flex; align-items: center; justify-content: center;
        opacity: 0; visibility: hidden; transition: 0.4s;
    }
    .settings-overlay.show { opacity: 1; visibility: visible; }

    .settings-content {
        background: #0a0a0a; border: 1px solid var(--glass-border);
        padding: 40px; border-radius: 24px; max-width: 500px; width: 90%;
        transform: scale(0.9); transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        box-shadow: 0 0 60px rgba(255, 255, 255, 0.2);
        max-height: 90vh;
        overflow-y: auto;
    }
    .settings-overlay.show .settings-content { transform: scale(1); }

    .settings-content h2 { margin-top: 0; font-size: 28px; font-weight: 700; margin-bottom: 30px; }
    .settings-group { margin-bottom: 25px; }
    .settings-label { display: block; font-size: 14px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 500; margin-bottom: 10px; }
    .settings-input { width: 100%; padding: 12px 15px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); border-radius: 12px; color: white; font-family: var(--font); font-size: 14px; }
    .settings-input:focus { border-color: rgba(255,255,255,0.3); background: rgba(255,255,255,0.08); }

    .settings-group.hidden { display: none; }

    /* Toggle Switch */
    .toggle-container { display: flex; align-items: center; gap: 15px; }
    .toggle-switch { position: relative; width: 50px; height: 28px; background: rgba(255,255,255,0.1); border-radius: 14px; cursor: pointer; border: 1px solid var(--glass-border); transition: 0.3s; }
    .toggle-switch.active { background: #22c55e; border-color: #22c55e; }
    .toggle-slider { position: absolute; top: 3px; left: 3px; width: 22px; height: 22px; background: white; border-radius: 50%; transition: 0.3s; }
    .toggle-switch.active .toggle-slider { left: 25px; }
    .toggle-label { font-size: 14px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 500; }

    .settings-buttons { display: flex; gap: 10px; margin-top: 30px; }
    .settings-btn { flex: 1; padding: 12px; border-radius: 12px; border: none; font-weight: 600; cursor: pointer; transition: 0.3s; font-family: var(--font); }
    .settings-btn.close { background: rgba(255,255,255,0.05); color: white; border: 1px solid var(--glass-border); }
    .settings-btn.close:hover { background: white; color: black; }

    /* Grid & Cards */
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 25px; }
    .card {
        background: var(--glass); border: 1px solid var(--glass-border); border-radius: 16px;
        overflow: hidden; transition: 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); display: flex; flex-direction: column;
        box-shadow: 0 0 30px rgba(255, 255, 255, 0.1);
    }
    .card:hover { 
        transform: translateY(-8px); 
        border-color: rgba(255,255,255,0.3);
        box-shadow: 0 0 50px rgba(255, 255, 255, 0.25);
    }
    
    .thumb { width: 100%; aspect-ratio: 16/9; background: #111; overflow: hidden; }
    .thumb img { width: 100%; height: 100%; object-fit: cover; transition: 0.6s; }
    .card:hover .thumb img { transform: scale(1.1); }
    
    .card-content { padding: 15px; flex: 1; display: flex; flex-direction: column; gap: 8px; }
    .game-title { font-size: 16px; font-weight: 600; }
    .card-actions { margin-top: auto; display: flex; gap: 10px; }
    .play-btn { flex: 1; background: white; color: black; font-weight: 700; border: none; display: flex; align-items: center; justify-content: center; gap: 8px; }

    /* Modal Overlay */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.9); backdrop-filter: blur(20px);
        z-index: 9998; display: none; opacity: 0; transition: 0.3s; align-items: center; justify-content: center;
    }
    .modal-overlay.active { display: flex; opacity: 1; }
    .modal-window { 
        width: 95vw; height: 90vh; background: #000; border: 1px solid var(--glass-border); 
        border-radius: 20px; display: flex; flex-direction: column; overflow: hidden;
        box-shadow: 0 0 80px rgba(255, 255, 255, 0.25);
    }
    .game-container { flex: 1; background: #000; position: relative; }
    iframe { width: 100%; height: 100%; border: none; opacity: 0; transition: opacity 0.3s; position: relative; z-index: 2; }
    iframe.loaded { opacity: 1; }
    .modal-bar { height: 70px; background: #0a0a0a; border-top: 1px solid var(--glass-border); display: flex; align-items: center; justify-content: space-between; padding: 0 25px; }
    
    .icon-btn { 
        width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; 
        border-radius: 12px; padding: 0; font-size: 20px; background: rgba(255,255,255,0.05);
        transition: 0.3s all;
        border: 1px solid rgba(255,255,255,0.1);
    }
    .icon-btn:hover {
        box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
        border-color: rgba(255,255,255,0.3);
    }
    .close-btn:hover { background: #ff3333 !important; color: white !important; border-color: #ff3333 !important; box-shadow: 0 0 25px rgba(255, 51, 51, 0.5) !important; }

    /* Skeleton Loader */
    .skeleton-loader {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: linear-gradient(
            135deg,
            #1a1a1a 0%,
            #2a2a2a 25%,
            #1a1a1a 50%,
            #2a2a2a 75%,
            #1a1a1a 100%
        );
        background-size: 200% 200%;
        animation: skeletonShimmer 3s ease-in-out forwards;
        z-index: 3;
    }
    @keyframes skeletonShimmer {
        0% { background-position: 0% 0%; }
        100% { background-position: 200% 200%; }
    }
    .skeleton-loader.hidden { display: none; z-index: 0; }

    /* Skeleton */
    .skeleton { background: var(--glass); height: 280px; border-radius: 16px; position: relative; overflow: hidden; box-shadow: 0 0 20px rgba(255, 255, 255, 0.08); }
    .skeleton::after { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.05), transparent); animation: shimmer 2s infinite; }
    @keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
</style>
</head>
<body>

<div class="popup-overlay" id="missionPopup">
    <div class="popup-content">
        <h2>Welcome</h2>
        <p>We believe gaming shouldn't have boundaries. Internet censorship is a relic of the past, and we're here to break through it. Whether you're at school, work, or anywhere in between, Moonlight keeps your gaming private and secure.</p>
        <button class="continue-btn" id="closePopup">Continue</button>
    </div>
</div>

<div class="settings-overlay" id="settingsPopup">
    <div class="settings-content">
        <h2>Settings</h2>
        
        <div class="settings-group">
            <label class="settings-label">Tab Cloak</label>
            <select id="cloakSelect" class="settings-input">
                <option value="default">Default (Moonlight)</option>
                <option value="google">Google</option>
                <option value="gcalculator">Google Calculator</option>
                <option value="gdrive">Google Drive</option>
                <option value="gdocs">Google Docs</option>
                <option value="gsheets">Google Sheets</option>
                <option value="gslides">Google Slides</option>
                <option value="gassign">Google Assignments</option>
                <option value="desmos">Desmos Calculator</option>
                <option value="transparent">Transparent</option>
                <option value="custom">Custom</option>
            </select>
        </div>

        <div class="settings-group hidden" id="customTitleGroup">
            <label class="settings-label">Tab Title</label>
            <input type="text" id="tabTitle" class="settings-input" placeholder="Enter tab title...">
        </div>

        <div class="settings-group hidden" id="customFaviconGroup">
            <label class="settings-label">Favicon URL</label>
            <input type="text" id="faviconUrl" class="settings-input" placeholder="Enter favicon URL...">
        </div>

        <div class="settings-group">
            <label class="settings-label">Anti Tab Close</label>
            <div class="toggle-container">
                <div class="toggle-switch" id="antiCloseToggle">
                    <div class="toggle-slider"></div>
                </div>
                <span class="toggle-label">Show close confirmation</span>
            </div>
        </div>

        <div class="settings-buttons">
            <button class="settings-btn close" id="closeSettings">Close</button>
        </div>
    </div>
</div>

<div class="wrap">
    <header class="header">
        <div class="brand">
            <div class="brand-text">
                <h1>Moonlight</h1>
                <p id="statusText">Connecting...</p>
                <div class="brand-stats">
                    <div class="online-indicator"></div>
                    <span id="onlineCount" class="online-count">0</span>
                    <span>Online</span>
                </div>
            </div>
        </div>
        <div class="controls">
            <input type="text" id="searchInput" placeholder="Search by name or tag...">
            <button id="refreshBtn"><i class="fa-solid fa-rotate"></i></button>
            <button id="settingsBtn"><i class="fa-solid fa-gear"></i></button>
        </div>
    </header>

    <div id="contentArea" class="grid">
        <div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div>
        <div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div>
    </div>
</div>

<div class="modal-overlay" id="gameModal">
    <div class="modal-window">
        <div class="game-container" id="gameContainer">
            <div class="skeleton-loader" id="skeletonLoader"></div>
            <iframe id="gameFrame" allowfullscreen sandbox="allow-scripts allow-same-origin allow-pointer-lock allow-forms"></iframe>
        </div>
        <div class="modal-bar">
            <div class="modal-info"><h2 id="modalTitle" style="margin:0; font-size:18px;">Game Title</h2></div>
            <div class="modal-controls" style="display:flex; gap:10px;">
                <button id="modalReload" class="icon-btn" title="Reload"><i class="fa-solid fa-rotate-right"></i></button>
                <button id="modalFullscreen" class="icon-btn" title="Fullscreen"><i class="fa-solid fa-expand"></i></button>
                <button id="modalClose" class="icon-btn close-btn" title="Close"><i class="fa-solid fa-xmark"></i></button>
            </div>
        </div>
    </div>
</div>

<script type="module">
    let games = [];
    let fetchTime = null;
    let currentGame = null;
    let antiCloseEnabled = false;
    let skeletonTimeout = null;
    let userId = null;
    let realtimeSubscription = null;
    let supabaseReady = false;

    const contentArea = document.getElementById('contentArea');
    const statusText = document.getElementById('statusText');
    const onlineCount = document.getElementById('onlineCount');
    const gameModal = document.getElementById('gameModal');
    const gameFrame = document.getElementById('gameFrame');
    const skeletonLoader = document.getElementById('skeletonLoader');
    const missionPopup = document.getElementById('missionPopup');
    const closePopupBtn = document.getElementById('closePopup');
    const settingsPopup = document.getElementById('settingsPopup');
    const settingsBtn = document.getElementById('settingsBtn');
    const closeSettingsBtn = document.getElementById('closeSettings');
    const cloakSelect = document.getElementById('cloakSelect');
    const tabTitleInput = document.getElementById('tabTitle');
    const faviconUrlInput = document.getElementById('faviconUrl');
    const antiCloseToggle = document.getElementById('antiCloseToggle');
    const customTitleGroup = document.getElementById('customTitleGroup');
    const customFaviconGroup = document.getElementById('customFaviconGroup');
    const refreshBtn = document.getElementById('refreshBtn');

    const CLOAK_BASE_URL = 'https://cdn.jsdelivr.net/gh/moonlight-site/moonlight-site.github.io/uploads/cloaks/';

    // Tab Cloak Presets
    const CLOAK_PRESETS = {
        default: {
            title: 'moonlight - games',
            favicon: 'https://cdn.jsdelivr.net/gh/moonlight-site/moonlight-site.github.io/branding/favicon.png'
        },
        google: {
            title: 'Google',
            favicon: CLOAK_BASE_URL + 'google.png'
        },
        gcalculator: {
            title: 'Calculator - Google Search',
            favicon: CLOAK_BASE_URL + 'google.png'
        },
        gdrive: {
            title: 'Google Drive',
            favicon: CLOAK_BASE_URL + 'gdrive.png'
        },
        gdocs: {
            title: 'Google Docs',
            favicon: CLOAK_BASE_URL + 'gdocs.png'
        },
        gsheets: {
            title: 'Google Sheets',
            favicon: CLOAK_BASE_URL + 'gsheets.png'
        },
        gslides: {
            title: 'Google Slides',
            favicon: CLOAK_BASE_URL + 'gslides.png'
        },
        gassign: {
            title: 'Google Assignments',
            favicon: CLOAK_BASE_URL + 'gassign.png'
        },
        desmos: {
            title: 'Desmos | Scientific Calculator',
            favicon: CLOAK_BASE_URL + 'desmos.png'
        },
        transparent: {
            title: 'Transparent',
            favicon: CLOAK_BASE_URL + 'transparent.png'
        }
    };

    // Generate unique user ID
    function generateUserId() {
        let id = localStorage.getItem('moonlight_user_id');
        if (!id) {
            id = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('moonlight_user_id', id);
        }
        return id;
    }

    // Handle Mission Popup
    window.addEventListener('load', () => {
        if (!localStorage.getItem('missionSeen')) {
            setTimeout(() => { missionPopup.classList.add('show'); }, 500);
        }
    });

    closePopupBtn.onclick = () => {
        missionPopup.classList.remove('show');
        localStorage.setItem('missionSeen', 'true');
    };

    // Settings Button
    settingsBtn.onclick = () => {
        settingsPopup.classList.add('show');
    };

    closeSettingsBtn.onclick = () => {
        settingsPopup.classList.remove('show');
    };

    // Close settings when clicking outside
    settingsPopup.onclick = (e) => {
        if (e.target === settingsPopup) {
            settingsPopup.classList.remove('show');
        }
    };

    // Tab Cloak Selection
    cloakSelect.onchange = (e) => {
        const isCustom = e.target.value === 'custom';
        customTitleGroup.classList.toggle('hidden', !isCustom);
        customFaviconGroup.classList.toggle('hidden', !isCustom);

        const preset = CLOAK_PRESETS[e.target.value];
        if (preset) {
            tabTitleInput.value = preset.title;
            faviconUrlInput.value = preset.favicon;
            applyTabCloak(preset.title, preset.favicon);
        }
    };

    // Tab Title Change
    tabTitleInput.onchange = () => {
        applyTabCloak(tabTitleInput.value, faviconUrlInput.value);
    };

    // Favicon URL Change
    faviconUrlInput.onchange = () => {
        applyTabCloak(tabTitleInput.value, faviconUrlInput.value);
    };

    // Apply Tab Cloak
    function applyTabCloak(title, faviconUrl) {
        document.title = title;
        
        let favicon = document.querySelector('link[rel="icon"]');
        if (favicon) {
            favicon.remove();
        }

        if (faviconUrl) {
            const newFavicon = document.createElement('link');
            newFavicon.rel = 'icon';
            newFavicon.href = faviconUrl;
            document.head.appendChild(newFavicon);
        }
    }

    // Anti Tab Close Toggle
    antiCloseToggle.onclick = () => {
        antiCloseToggle.classList.toggle('active');
        antiCloseEnabled = antiCloseToggle.classList.contains('active');
        
        if (antiCloseEnabled) {
            window.onbeforeunload = (e) => {
                e.preventDefault();
                e.returnValue = '';
                return '';
            };
        } else {
            window.onbeforeunload = null;
        }
    };

    // --- FALLBACK HTML ---
    const FALLBACK_HTML = `
        <!DOCTYPE html>
        <html>
        <head>
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
            <style>
                body { background: #050505; color: #fff; font-family: 'Inter Tight', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; }
                .container { max-width: 400px; padding: 20px; }
                i { font-size: 50px; color: #ffcc00; margin-bottom: 20px; }
                h1 { margin: 10px 0; font-size: 24px; font-weight: 600; }
                p { color: #888; line-height: 1.5; font-size: 16px; }
            </style>
        </head>
        <body>
            <div class="container">
                <i class="fa-solid fa-triangle-exclamation"></i>
                <h1>Game couldn't be fetched.</h1>
                <p>Don't worry, it's on us. Looks like this game is missing valid source code, we're working on it.</p>
            </div>
        </body>
        </html>
    `;

    function initSupabase() {
        const url = 'https://mrkhmlhrbtedudclwfli.supabase.co';
        const key = 'sb_publishable_Ej0sVQdRrHnWnctlZxWI3g_djchZi4L';
        if (window.supabase) {
            window.supabaseClient = window.supabase.createClient(url, key);
            supabaseReady = true;
            console.log('Supabase initialized');
            initOnlineTracking();
            loadData();
        }
    }

    function updateStatus() {
        if (!fetchTime) return;
        const diff = Math.floor((Date.now() - fetchTime) / 60000);
        if (diff < 1) statusText.innerText = "LAST UPDATED JUST NOW";
        else statusText.innerText = `UPDATED ${diff} MINUTE${diff === 1 ? '' : 'S'} AGO`;
    }

    // Fetch online count
    async function fetchOnlineCount() {
        try {
            const { data, error } = await window.supabaseClient
                .from('online_users')
                .select('user_id', { count: 'exact' })
                .gt('last_seen', new Date(Date.now() - 5 * 60000).toISOString());
            
            if (!error && data) {
                onlineCount.textContent = data.length;
                console.log('Online users:', data.length);
            } else {
                console.error('Error fetching online count:', error);
            }
        } catch (err) {
            console.error('Error in fetchOnlineCount:', err);
        }
    }

    // Initialize online tracking
    async function initOnlineTracking() {
        if (!supabaseReady) {
            console.log('Supabase not ready yet, retrying...');
            setTimeout(initOnlineTracking, 500);
            return;
        }

        userId = generateUserId();
        console.log('Initializing online tracking with user ID:', userId);

        try {
            const { data, error } = await window.supabaseClient
                .from('online_users')
                .insert([{
                    user_id: userId,
                    last_seen: new Date().toISOString()
                }]);

            if (error) {
                console.error('Error inserting user:', error);
                return;
            } else {
                console.log('User inserted successfully');
            }

            await fetchOnlineCount();

            realtimeSubscription = window.supabaseClient
                .channel('online_users')
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'online_users'
                }, async (payload) => {
                    console.log('Realtime update:', payload);
                    await fetchOnlineCount();
                })
                .subscribe((status) => {
                    console.log('Realtime subscription status:', status);
                });

            setInterval(() => {
                window.supabaseClient
                    .from('online_users')
                    .update({ last_seen: new Date().toISOString() })
                    .eq('user_id', userId)
                    .then(({ error }) => {
                        if (error) console.error('Error updating last_seen:', error);
                        else console.log('Updated last_seen at', new Date().toLocaleTimeString());
                    });
            }, 30000);

        } catch (err) {
            console.error('Error initializing online tracking:', err);
        }
    }

    // Cleanup on page leave
    window.addEventListener('beforeunload', async () => {
        if (realtimeSubscription) {
            realtimeSubscription.unsubscribe();
        }
        if (userId && supabaseReady) {
            await window.supabaseClient.from('online_users').delete().eq('user_id', userId);
        }
    });

    async function loadData() {
        const btnIcon = document.querySelector('#refreshBtn i');
        if(btnIcon) btnIcon.classList.add('fa-spin');

        showMenuSkeletons();

        const { data, error } = await window.supabaseClient.from('games').select('*').range(0, 999);
        
        if (error) {
            console.error(error);
        } else {
            games = data.sort((a, b) => a.name.localeCompare(b.name));
            fetchTime = Date.now();
            updateStatus();
            renderGrid(games);
        }
        
        if(btnIcon) btnIcon.classList.remove('fa-spin');
    }

    function showMenuSkeletons() {
        contentArea.innerHTML = '';
        for (let i = 0; i < 6; i++) {
            const skeleton = document.createElement('div');
            skeleton.className = 'skeleton';
            contentArea.appendChild(skeleton);
        }
    }

    function renderGrid(data) {
        contentArea.innerHTML = '';
        data.forEach(game => {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <div class="thumb"><img src="${game.img_url || ''}"></div>
                <div class="card-content">
                    <div class="game-title">${game.name}</div>
                    <div class="card-actions"><button class="play-btn"><i class="fa-solid fa-play"></i> Play</button></div>
                </div>
            `;
            card.querySelector('.play-btn').onclick = () => openGame(game);
            contentArea.appendChild(card);
        });
    }

    function showSkeletonLoader() {
        if (skeletonTimeout) clearTimeout(skeletonTimeout);
        
        skeletonLoader.classList.remove('hidden');
        gameFrame.classList.remove('loaded');
        
        skeletonTimeout = setTimeout(() => {
            skeletonLoader.classList.add('hidden');
            gameFrame.classList.add('loaded');
        }, 3000);
    }

    function openGame(game) {
        currentGame = game;
        document.getElementById('modalTitle').textContent = game.name;
        gameModal.classList.add('active');
        
        showSkeletonLoader();
        
        const isUrlBroken = (game.url && game.url.startsWith('/'));
        
        if (game.html) {
            injectHtml(game.html);
        } else if (game.url && !isUrlBroken) {
            gameFrame.src = game.url;
        } else {
            injectHtml(FALLBACK_HTML);
        }
    }

    function injectHtml(htmlCode) {
        gameFrame.src = 'about:blank';
        setTimeout(() => {
            const doc = gameFrame.contentWindow.document;
            doc.open();
            doc.write(htmlCode);
            doc.close();
        }, 50);
    }

    // Modal Events
    document.getElementById('modalClose').onclick = () => { 
        gameModal.classList.remove('active'); 
        gameFrame.src = '';
        if (skeletonTimeout) clearTimeout(skeletonTimeout);
    };
    
    document.getElementById('modalReload').onclick = () => { 
        if(currentGame) {
            showSkeletonLoader();
            openGame(currentGame);
        }
    };
    
    document.getElementById('modalFullscreen').onclick = () => {
        const container = document.getElementById('gameContainer');
        if (!document.fullscreenElement) {
            container.requestFullscreen().catch(err => {
                alert(`Error attempting to enable fullscreen: ${err.message}`);
            });
        } else {
            document.exitFullscreen();
        }
    };

    // SEARCH LOGIC
    document.getElementById('searchInput').oninput = (e) => {
        const term = e.target.value.toLowerCase();
        
        const filtered = games.filter(g => {
            const inName = g.name.toLowerCase().includes(term);
            const inTags = g.tags && Array.isArray(g.tags) && g.tags.some(t => t.toLowerCase().includes(term));
            return inName || inTags;
        });

        renderGrid(filtered);
    };

    // REFRESH BUTTON
    refreshBtn.onclick = () => {
        document.getElementById('searchInput').value = '';
        loadData();
    };

    // Status Timer
    setInterval(updateStatus, 60000);

    // Init Supabase
    const checkSup = setInterval(() => { 
        if(window.supabase) { 
            initSupabase(); 
            clearInterval(checkSup); 
        } 
    }, 100);

</script>
</body>
</html>
